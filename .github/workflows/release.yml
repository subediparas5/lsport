name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10

permissions:
  contents: write

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Get and verify version
        id: version
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          TAG="${GITHUB_REF_NAME}"
          CARGO_VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          if [ "$CARGO_VERSION" != "$VERSION" ]; then
            echo "❌ Version mismatch: Cargo.toml=$CARGO_VERSION, tag=$VERSION"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "✅ Version $VERSION (tag: $TAG)"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Lsport ${{ github.ref_name }}
          body: |
            ## Lsport ${{ github.ref_name }}

            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.

            ### Installation

            **Homebrew (macOS/Linux):**
            ```bash
            brew install subediparas5/tap/lsport
            ```

            **Debian/Ubuntu (APT):**
            ```bash
            curl -fsSL https://subediparas5.github.io/lsport/install.sh | bash
            ```

            **Cargo:**
            ```bash
            cargo install lsport
            ```
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}

  build-release:
    name: Build ${{ matrix.artifact }}
    needs: create-release
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            artifact: lsport-linux-x86_64
            deb_arch: amd64
          - os: ubuntu-22.04
            target: aarch64-unknown-linux-gnu
            artifact: lsport-linux-aarch64
            deb_arch: arm64
            cross: true
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact: lsport-macos-x86_64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact: lsport-macos-aarch64

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: release-${{ matrix.target }}

      - name: Install tools
        run: |
          if [ "${{ matrix.cross }}" = "true" ]; then
            cargo install cross --git https://github.com/cross-rs/cross
          fi
          if [ "${{ runner.os }}" = "Linux" ]; then
            cargo install cargo-deb
          fi

      - name: Build release
        run: |
          if [ "${{ matrix.cross }}" = "true" ]; then
            cross build --release --target ${{ matrix.target }}
          else
            cargo build --release --target ${{ matrix.target }}
          fi

      - name: Package
        run: |
          cd target/${{ matrix.target }}/release
          tar -czvf ../../../${{ matrix.artifact }}.tar.gz lsport

      - name: Build .deb
        if: runner.os == 'Linux'
        run: |
          cargo deb --no-build --target ${{ matrix.target }}
          cp target/${{ matrix.target }}/debian/*.deb ./lsport_${{ needs.create-release.outputs.version }}_${{ matrix.deb_arch }}.deb

      - name: Upload tarball
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ matrix.artifact }}.tar.gz

      - name: Upload deb
        if: runner.os == 'Linux'
        uses: softprops/action-gh-release@v2
        with:
          files: lsport_${{ needs.create-release.outputs.version }}_${{ matrix.deb_arch }}.deb

      - name: Save deb artifact
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: deb-${{ matrix.deb_arch }}
          path: lsport_${{ needs.create-release.outputs.version }}_${{ matrix.deb_arch }}.deb
          retention-days: 1

  # These jobs run in parallel after build-release
  publish-crates:
    name: Publish to crates.io
    needs: [create-release, build-release]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Publish
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish --allow-dirty

  update-homebrew:
    name: Update Homebrew
    needs: [create-release, build-release]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: subediparas5/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      - name: Update and push
        run: |
          sed -i 's/tag: "v[0-9]*\.[0-9]*\.[0-9]*"/tag: "${{ github.ref_name }}"/' Formula/lsport.rb
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/lsport.rb
          git commit -m "Update lsport to ${{ github.ref_name }}" || true
          git push

  update-apt-repo:
    name: Update APT Repository
    needs: [create-release, build-release]
    runs-on: ubuntu-latest
    steps:
      - name: Download deb artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: deb-*
          path: debs
          merge-multiple: true

      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: repo

      - name: Import GPG key
        id: gpg
        run: |
          echo "${{ secrets.APT_GPG_PRIVATE_KEY }}" | gpg --batch --import
          KEY_ID=$(gpg --list-secret-keys --with-colons | grep '^sec' | cut -d':' -f5)
          echo "key_id=$KEY_ID" >> $GITHUB_OUTPUT

      - name: Update repository
        run: |
          cd repo
          mkdir -p pool/main dists/stable/main/binary-amd64 dists/stable/main/binary-arm64
          cp ../debs/*.deb pool/main/ 2>/dev/null || true
          gpg --armor --export "${{ steps.gpg.outputs.key_id }}" > KEY.gpg

          # Generate Packages
          dpkg-scanpackages --arch amd64 pool/main /dev/null > dists/stable/main/binary-amd64/Packages 2>/dev/null || true
          dpkg-scanpackages --arch arm64 pool/main /dev/null > dists/stable/main/binary-arm64/Packages 2>/dev/null || true
          gzip -k -f dists/stable/main/binary-amd64/Packages
          gzip -k -f dists/stable/main/binary-arm64/Packages

          # Generate Release
          cd dists/stable
          cat > Release << EOF
          Origin: lsport
          Label: lsport
          Suite: stable
          Codename: stable
          Architectures: amd64 arm64
          Components: main
          Description: APT repository for lsport
          EOF
          apt-ftparchive release . >> Release

          # Sign
          rm -f InRelease Release.gpg
          gpg --batch --yes --pinentry-mode loopback --clearsign --default-key "${{ steps.gpg.outputs.key_id }}" -o InRelease Release
          gpg --batch --yes --pinentry-mode loopback --default-key "${{ steps.gpg.outputs.key_id }}" -abs -o Release.gpg Release

      - name: Create install script
        run: |
          cd repo
          cat > install.sh << 'EOF'
          #!/bin/bash
          set -e
          echo "Installing lsport..."
          curl -fsSL https://subediparas5.github.io/lsport/KEY.gpg | sudo gpg --dearmor -o /usr/share/keyrings/lsport.gpg
          echo "deb [signed-by=/usr/share/keyrings/lsport.gpg arch=$(dpkg --print-architecture)] https://subediparas5.github.io/lsport stable main" | sudo tee /etc/apt/sources.list.d/lsport.list
          sudo apt update && sudo apt install -y lsport
          echo "✅ lsport installed!"
          EOF
          chmod +x install.sh

      - name: Push
        run: |
          cd repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Update APT repo for ${{ github.ref_name }}" || true
          git push origin gh-pages

  upload-debian-mentors:
    name: Upload to Debian Mentors
    needs: [create-release, build-release]
    runs-on: ubuntu-latest
    container:
      image: rust:1.88-bookworm
    steps:
      - name: Install tools
        run: |
          apt-get update
          apt-get install -y debhelper devscripts dput gnupg libssl-dev libssh2-1-dev zlib1g-dev pkg-config lintian

      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-release.outputs.tag }}
          fetch-depth: 0

      - name: Import GPG key
        id: gpg
        run: |
          echo "${{ secrets.APT_GPG_PRIVATE_KEY }}" | gpg --batch --import
          KEY_ID=$(gpg --list-secret-keys --with-colons | grep '^sec' | cut -d':' -f5)
          echo "key_id=$KEY_ID" >> $GITHUB_OUTPUT

      - name: Configure Git
        run: |
          git config --global user.name "Parash Subedi"
          git config --global user.email "subediparas5@gmail.com"
          git config --global --add safe.directory /__w/lsport/lsport

      - name: Update changelog
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          echo "Checking changelog for version: ${VERSION}"
          if [ -f debian/changelog ]; then
            # Check if changelog already has the correct version at the top
            if head -1 debian/changelog | grep -q "lsport (${VERSION}-1)"; then
              echo "Changelog already has version ${VERSION}, skipping update"
            else
              # Prepend to existing changelog
              echo "Prepending new changelog entry for version ${VERSION}"
              cat > debian/changelog.new << EOF
          lsport (${VERSION}-1) unstable; urgency=medium

            * Release version ${VERSION}
            * See https://github.com/subediparas5/lsport/releases/tag/v${VERSION}

           -- Parash Subedi <subediparas5@gmail.com>  $(date -R)
          EOF
              cat debian/changelog >> debian/changelog.new
              mv debian/changelog.new debian/changelog
            fi
          else
            # Create new changelog
            echo "Creating new changelog for version ${VERSION}"
            cat > debian/changelog << EOF
          lsport (${VERSION}-1) unstable; urgency=medium

            * Release version ${VERSION}
            * See https://github.com/subediparas5/lsport/releases/tag/v${VERSION}

           -- Parash Subedi <subediparas5@gmail.com>  $(date -R)
          EOF
          fi

      - name: Vendor dependencies for offline build
        run: |
          echo "Vendoring Cargo dependencies for offline Debian build..."
          cargo vendor vendor

          # Create .cargo/config.toml to use vendored sources
          mkdir -p .cargo
          printf '%s\n' '[source.crates-io]' 'replace-with = "vendored-sources"' '' '[source.vendored-sources]' 'directory = "vendor"' > .cargo/config.toml

          # Remove unnecessary files to fix lintian errors:
          # - Windows-specific library files (not needed for Linux)
          # - Pre-generated rustdoc output (source-is-missing errors)
          # Note: Keep vendor/*/doc/ - those contain compile-time includes
          echo "Cleaning up unnecessary vendor files..."
          rm -rf vendor/winapi-i686-pc-windows-gnu/lib/*.a
          rm -rf vendor/winapi-x86_64-pc-windows-gnu/lib/*.a
          rm -rf vendor/*/docs/
          rm -rf vendor/windows*/lib/*.a 2>/dev/null || true

          # Clear checksums for Debian compatibility (source may be modified)
          for f in vendor/*/.cargo-checksum.json; do
            sed -i 's/"files":{[^}]*}/"files":{}/' "$f" || true
          done

          echo "✅ Vendored $(ls -d vendor/*/ | wc -l) crates"

      - name: Build and upload
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          WORKDIR=$(pwd)

          # Create orig.tar.gz (includes vendor and .cargo for offline builds)
          tar --exclude='.git' --exclude='debian' --exclude='target' -czf ../lsport_${VERSION}.orig.tar.gz .

          # Build source package in a clean directory to avoid dpkg-source errors
          # (dpkg-source compares working dir to tarball - they must be identical)
          cd ..
          mkdir -p build-area
          cd build-area
          tar -xzf ../lsport_${VERSION}.orig.tar.gz
          cp -a "${WORKDIR}/debian" .

          # Build source package
          dpkg-buildpackage -S -sa -d -k"${{ steps.gpg.outputs.key_id }}"

          # Clean up build area
          cd ..
          rm -rf build-area

          echo "--- Lintian ---"
          lintian --info lsport_${VERSION}-1.dsc || true

          cat > ~/.dput.cf << 'DPUTEOF'
          [mentors]
          fqdn = mentors.debian.net
          incoming = /upload
          method = https
          allow_unsigned_uploads = 0
          DPUTEOF

          echo "Uploading lsport_${VERSION}-1_source.changes to Debian Mentors..."
          if dput mentors lsport_${VERSION}-1_source.changes; then
            echo "✅ Successfully uploaded version ${VERSION} to Debian Mentors"
          else
            echo "❌ Failed to upload to Debian Mentors"
            exit 1
          fi

      - name: Copy artifacts to workspace
        run: |
          WORKDIR=$(pwd)
          cd ..
          cp lsport_*.orig.tar.gz lsport_*.debian.tar.xz lsport_*.dsc lsport_*.changes "${WORKDIR}/"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debian-source-package
          path: |
            lsport_*.orig.tar.gz
            lsport_*.debian.tar.xz
            lsport_*.dsc
            lsport_*.changes
          retention-days: 7
